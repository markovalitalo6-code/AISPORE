import { Bot } from "grammy";
import { ensureUserRecord } from "./referral";
import { ensureBadgesFile } from "./referral.utils";

const GROUP_CHAT_ID = process.env.TELEGRAM_CHAT_ID ?? "";

export async function handleNewGroupMember(
  bot: Bot,
  memberUserId: number,
  memberUsername?: string,
  memberFirstName?: string
) {
  const welcomeText = `
ğŸ„ WELCOME TO AISPORE | FOUNDING PLAYERS

Youâ€™re early. This is the core group before launch.

âš ï¸ IMPORTANT â€” PLEASE READ (1 minute)

You will receive a message from **@AISporeHostBot**.
ğŸ‘‰ This is NOT spam.
ğŸ‘‰ This is REQUIRED to activate your participation.

Telegram does NOT allow bots to message you first.

---

âœ… WHAT YOU MUST DO (VERY SIMPLE)

1ï¸âƒ£ Open **@AISporeHostBot**
2ï¸âƒ£ Tap **Start**

Thatâ€™s it. Nothing else.

---

ğŸ–ï¸ WHAT YOU GET AFTER ACTIVATION

â€¢ Your personal referral link  
â€¢ Your badge (ğŸ¥‰ Bronze â†’ ğŸ¥ˆ Silver â†’ ğŸ¥‡ Gold â†’ ğŸ’ Diamond)  
â€¢ Access to future rewards & advantages  
â€¢ Check your status anytime with **/me**

âš ï¸ If you do NOT open the bot:
You remain an observer and are NOT included in rewards.

---

ğŸ§  COMMON ISSUE

If you didnâ€™t get a DM yet:
ğŸ‘‰ Open **@AISporeHostBot** and tap **Start**

This is a Telegram limitation.

---

ğŸ§­ WHAT AISPORE IS

âœ”ï¸ Community-first  
âœ”ï¸ Long-term focused  
âœ”ï¸ Early participation matters  

âŒ Not a pump group  
âŒ Not financial advice  

---

ğŸš€ TL;DR

â€¢ Joined the group âœ…  
â€¢ Opened @AISporeHostBot once âœ…  
â€¢ Youâ€™re fully activated ğŸ„
`.trim();

  try {
    if (GROUP_CHAT_ID) {
      await bot.api.sendMessage(GROUP_CHAT_ID, welcomeText, {
        parse_mode: "Markdown",
      });
    }
  } catch (e) {
    console.error("Failed to post welcome message:", e);
  }

  try {
    await ensureBadgesFile();
    await ensureUserRecord(memberUserId, memberUsername ?? "");
  } catch (e) {
    console.error("Failed to init user record:", e);
  }
}
