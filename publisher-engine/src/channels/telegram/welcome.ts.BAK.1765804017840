import { Bot } from "grammy";
import { ensureUserRecord } from "./referral";
import { ensureBadgesFile } from "./referral.utils";

const GROUP_CHAT_ID = process.env.TELEGRAM_CHAT_ID ?? "";

export async function handleNewGroupMember(
  bot: Bot,
  memberUserId: number,
  memberUsername?: string,
  memberFirstName?: string
) {
  const welcomeText = `ğŸ„ Welcome to AISPORE â€” Founding Players

Quick rule (Telegram limitation):
Personal info cannot be reliably shown inside the group chat.
So the group will ask you to move to the bot for your private status.

ğŸ¤– AISPORE Host Bot (PRIVATE CHAT)
1) Open: @AISporeHostBot
2) Press START
3) Use commands:

âœ… Your status â†’ /status
ğŸ”— Your referral link â†’ /ref
ğŸ·ï¸ Your badges â†’ /status
ğŸŸï¸ Your tickets â†’ /status
ğŸš€ Activate DMs (required once) â†’ /start

If the bot says â€œSent in private chatâ€:
Open @AISporeHostBot and type /start once, then /status.

Welcome in. Stay sharp. ğŸ§¬`.trim();

  try {
    if (GROUP_CHAT_ID) {
      await bot.api.sendMessage(GROUP_CHAT_ID, welcomeText, {
        parse_mode: "Markdown",
      });
    }
  } catch (e) {
    console.error("Failed to post welcome message:", e);
  }

  try {
    await ensureBadgesFile();
    await ensureUserRecord(memberUserId, memberUsername ?? "");
  } catch (e) {
    console.error("Failed to init user record:", e);
  }
}
