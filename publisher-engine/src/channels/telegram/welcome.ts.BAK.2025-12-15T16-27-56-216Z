import { Bot } from "grammy";
import { ensureUserRecord } from "./referral";
import { ensureBadgesFile } from "./referral.utils";

const GROUP_CHAT_ID = process.env.TELEGRAM_CHAT_ID ?? "";

export async function handleNewGroupMember(
  bot: Bot,
  memberUserId: number,
  memberUsername?: string,
  memberFirstName?: string
) {
  const welcomeText = `ğŸ„ AISPORE â€” Founding Players

âš ï¸ READ THIS CAREFULLY (Telegram limitation)

Telegram does NOT allow showing personal data
(referrals, tickets, badges, status)
reliably inside a GROUP chat.

ğŸ‘‰ Because of this, AISPORE uses a PRIVATE Host Bot
for ALL personal information.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ¤– AISPORE HOST BOT (PRIVATE CHAT)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1ï¸âƒ£ Open the bot:
ğŸ‘‰ @AISporeHostBot

2ï¸âƒ£ Press START (required once)
Telegram blocks bots until you do this.

3ï¸âƒ£ Use these commands INSIDE THE BOT CHAT
(not in this group):

âœ… /status â€” your full status card
ğŸ”— /ref â€” your personal referral link
ğŸ† /leaders â€” referral leaderboard

â— Important:
If you see:
â€œSent in private chatâ€

It means Telegram blocked the bot.
Fix it like this:
â†’ Open @AISporeHostBot
â†’ Type /start once
â†’ Then type /status

Thatâ€™s it.

Welcome in. Stay sharp. ğŸ§¬`.trim();

  try {
    if (GROUP_CHAT_ID) {
      await bot.api.sendMessage(GROUP_CHAT_ID, welcomeText, {
        parse_mode: "Markdown",
      });
    }
  } catch (e) {
    console.error("Failed to post welcome message:", e);
  }

  try {
    await ensureBadgesFile();
    await ensureUserRecord(memberUserId, memberUsername ?? "");
  } catch (e) {
    console.error("Failed to init user record:", e);
  }

  try {
    if (process.env.AUTO_DM_STATUS_ON_JOIN === "1") {
      const dmText = `ğŸ¤– AISPORE HOST BOT

This bot handles ALL your personal AISPORE data.

Available commands:
âœ… /status â€” your status card
ğŸ”— /ref â€” your referral link
ğŸ† /leaders â€” leaderboard

Important:
â€¢ Commands work ONLY here (private chat)
â€¢ Group chat cannot show personal data
â€¢ Hold-based badges activate after token launch + snapshot

You are now connected. ğŸ§¬

Tip: type /status to begin.`;

      await bot.api.sendMessage(memberUserId, dmText);
    }
  } catch (e) {
    console.error("Failed to DM user:", e);
  }
}
