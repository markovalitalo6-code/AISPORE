import { Bot } from "grammy";
import { ensureUserRecord } from "./referral";
import { ensureBadgesFile } from "./referral.utils";

const GROUP_CHAT_ID = process.env.TELEGRAM_CHAT_ID ?? "";

export async function handleNewGroupMember(
  bot: Bot,
  memberUserId: number,
  memberUsername?: string,
  memberFirstName?: string
) {
  const welcomeText = `ğŸ„ AISPORE â€” Founding Players

âš ï¸ READ THIS (Telegram limitation)
Personal status (referrals, tickets, badges) cannot be shown reliably in the GROUP chat.
So AISPORE uses a PRIVATE Host Bot for all personal info.

âœ… WHAT YOU MUST DO (1 minute)
1) Open the bot: @AISporeHostBot
2) Press START (required once)
3) Write commands INSIDE THE BOT CHAT (NOT in this group)

ğŸ¤– Commands (in @AISporeHostBot private chat)
âœ… /status  â€” your status card (referrals, tickets, badges)
ğŸ”— /ref     â€” your personal referral link
ğŸ† /leaders â€” top referrers

If the group says: â€œSent your info in a private chatâ€
â†’ Open @AISporeHostBot â†’ type /start once â†’ then /status

Welcome in. Stay sharp. ğŸ§¬`.trim();

  try {
    if (GROUP_CHAT_ID) {
      await bot.api.sendMessage(GROUP_CHAT_ID, welcomeText, {
        parse_mode: "Markdown",
      });
    }
  } catch (e) {
    console.error("Failed to post welcome message:", e);
  }

  try {
    await ensureBadgesFile();
    await ensureUserRecord(memberUserId, memberUsername ?? "");
  } catch (e) {
    console.error("Failed to init user record:", e);
  }

  try {
    if (process.env.AUTO_DM_STATUS_ON_JOIN === "1") {
      const dmText = `ğŸ¤– AISPORE HOST BOT

This bot handles ALL your personal AISPORE data.

Available commands:
âœ… /status â€” your status card
ğŸ”— /ref â€” your referral link
ğŸ† /leaders â€” leaderboard

Important:
â€¢ Commands work ONLY here (private chat)
â€¢ Group chat cannot show personal data
â€¢ Hold-based badges activate after token launch + snapshot

You are now connected. ğŸ§¬

Tip: type /status to begin.`;

      await bot.api.sendMessage(memberUserId, dmText);
    }
  } catch (e) {
    console.error("Failed to DM user:", e);
  }
}
