import { Bot } from "grammy";
import { ensureUserRecord } from "./referral";
import { ensureBadgesFile } from "./referral.utils";

const GROUP_CHAT_ID = process.env.TELEGRAM_CHAT_ID ?? "";

export async function handleNewGroupMember(
  bot: Bot,
  memberUserId: number,
  memberUsername?: string,
  memberFirstName?: string
) {
  // === AISPORE_GROUP_WELCOME_V1 ===
  // Warm welcome in Founding Players group + auto-delete after 3 minutes (keeps chat clean)
  try {
    const member = ctx.message?.new_chat_members?.[0];
    if (member) {
      const uname = (member as any).username ? `@${(member as any).username}` : "";
      const display = uname || (member as any).first_name || "A new member";

      const text =
        "ğŸ„ Welcome to AISPORE â€” Founding Players\n\n" +
        `${display} joined the inner layer.\n\n` +
        "Youâ€™re now part of the early community helping shape what AISPORE becomes.\n" +
        "No noise. No rush. Just builders, holders, and long-term alignment.\n\n" +
        "ğŸ“Œ What matters here:\n" +
        "â€¢ Participation over time\n" +
        "â€¢ Holding over hype\n" +
        "â€¢ Growing the ecosystem together\n\n" +
        "You donâ€™t need to do anything right now.\n" +
        "Explore, observe, and stay aligned.\n\n" +
        "Welcome aboard. ğŸ„";

      const sent = await ctx.reply(text);

      // Auto-delete after 3 minutes
      setTimeout(() => {
        ctx.api.deleteMessage(sent.chat.id, sent.message_id).catch(() => {});
      }, 180_000);
    }
  } catch (e) {
    console.error("AISPORE_GROUP_WELCOME_V1 failed:", e);
  }
  // === END AISPORE_GROUP_WELCOME_V1 ===


  const welcomeText = `ğŸ„ AISPORE â€” Founding Players

âš ï¸ READ THIS (Telegram limitation)
Personal status (referrals, tickets, badges) cannot be shown reliably in the GROUP chat.
So AISPORE uses a PRIVATE Host Bot for all personal info.

âœ… WHAT YOU MUST DO (1 minute)
1) Open the bot: @AISporeHostBot
2) Press START (required once)
3) Write commands INSIDE THE BOT CHAT (NOT in this group)

ğŸ¤– Commands (in @AISporeHostBot private chat)
âœ… /status  â€” your status card (referrals, tickets, badges)
ğŸ”— /ref     â€” your personal referral link
ğŸ† /leaders â€” top referrers

If the group says: â€œSent your info in a private chatâ€
â†’ Open @AISporeHostBot â†’ type /start once â†’ then /status

Welcome in. Stay sharp. ğŸ§¬`.trim();

  try {
    if (GROUP_CHAT_ID) {
      await bot.api.sendMessage(GROUP_CHAT_ID, welcomeText, {
        parse_mode: "Markdown",
      });
    }
  } catch (e) {
    console.error("Failed to post welcome message:", e);
  }

  try {
    await ensureBadgesFile();
    await ensureUserRecord(memberUserId, memberUsername ?? "");
  } catch (e) {
    console.error("Failed to init user record:", e);
  }

  try {
    if (process.env.AUTO_DM_STATUS_ON_JOIN === "1") {
      const dmText = `ğŸ¤– AISPORE HOST BOT

This bot handles ALL your personal AISPORE data.

Available commands:
âœ… /status â€” your status card
ğŸ”— /ref â€” your referral link
ğŸ† /leaders â€” leaderboard

Important:
â€¢ Commands work ONLY here (private chat)
â€¢ Group chat cannot show personal data
â€¢ Hold-based badges activate after token launch + snapshot

You are now connected. ğŸ§¬

Tip: type /status to begin.`;

      await bot.api.sendMessage(memberUserId, dmText);
    }
  } catch (e) {
    console.error("Failed to DM user:", e);
  }
}
